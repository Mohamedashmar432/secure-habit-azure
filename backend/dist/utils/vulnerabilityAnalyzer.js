"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.analyzeVulnerabilities = analyzeVulnerabilities;
exports.analyzeExploitability = analyzeExploitability;
// Mock CVE database - In production, this would query real CVE databases
const MOCK_CVE_DATABASE = {
    'chrome-118.0.5993.89': [
        {
            cveId: 'CVE-2024-1234',
            cvssScore: 9.8,
            severity: 'critical',
            description: 'Remote code execution vulnerability in Chrome',
            exploitable: true,
            recommendation: 'Update to Chrome 120.0.6099.129',
            affectedEndpoints: ['/api/users', '/api/data'],
        },
        {
            cveId: 'CVE-2024-1235',
            cvssScore: 7.5,
            severity: 'high',
            description: 'Privilege escalation vulnerability',
            exploitable: false,
            recommendation: 'Update to Chrome 120.0.6099.129',
            affectedEndpoints: [],
        },
    ],
    'firefox-119.0': [
        {
            cveId: 'CVE-2024-2001',
            cvssScore: 8.2,
            severity: 'high',
            description: 'Memory corruption vulnerability',
            exploitable: true,
            recommendation: 'Update to Firefox 121.0',
            affectedEndpoints: ['/api/upload'],
        },
    ],
    'nodejs-18.17.0': [
        {
            cveId: 'CVE-2024-3001',
            cvssScore: 9.1,
            severity: 'critical',
            description: 'Remote code execution in Node.js',
            exploitable: true,
            recommendation: 'Update to Node.js 20.11.0',
            affectedEndpoints: ['/api/*'],
        },
    ],
    'express-4.17.1': [
        {
            cveId: 'CVE-2024-4001',
            cvssScore: 7.8,
            severity: 'high',
            description: 'Path traversal vulnerability',
            exploitable: false,
            recommendation: 'Update to Express 4.18.2',
            affectedEndpoints: ['/api/files'],
        },
    ],
};
function analyzeVulnerabilities(scan) {
    const vulnerabilities = [];
    scan.software?.forEach(software => {
        // Normalize software name for better matching
        let normalizedName = software.name.toLowerCase();
        // Handle common software name variations
        const nameMapping = {
            'google chrome': 'chrome',
            'mozilla firefox': 'firefox',
            'microsoft edge': 'edge',
            'node.js': 'nodejs',
            'visual studio code': 'vscode',
            'adobe acrobat reader': 'adobe reader',
            'adobe reader dc': 'adobe reader'
        };
        // Apply name mapping
        if (nameMapping[normalizedName]) {
            normalizedName = nameMapping[normalizedName];
        }
        // Create a key from normalized software name and version
        const key = `${normalizedName}-${software.version}`;
        console.log(`Checking vulnerabilities for: ${software.name} v${software.version} (key: ${key})`);
        // Check mock database for exact match
        let cves = MOCK_CVE_DATABASE[key] || [];
        // If no exact match, check partial matches
        if (cves.length === 0) {
            Object.keys(MOCK_CVE_DATABASE).forEach(dbKey => {
                if (dbKey.startsWith(normalizedName + '-')) {
                    console.log(`Found partial match: ${dbKey} for ${normalizedName}`);
                    cves.push(...MOCK_CVE_DATABASE[dbKey]);
                }
            });
        }
        console.log(`Found ${cves.length} CVEs for ${software.name}`);
        cves.forEach((cve) => {
            vulnerabilities.push({
                software: software.name,
                version: software.version,
                cveId: cve.cveId,
                cvssScore: cve.cvssScore,
                severity: cve.severity,
                description: cve.description,
                exploitable: cve.exploitable,
                recommendation: cve.recommendation,
                affectedEndpoints: cve.affectedEndpoints || [],
            });
        });
    });
    console.log(`Total vulnerabilities found: ${vulnerabilities.length}`);
    // Calculate totals
    const critical = vulnerabilities.filter(v => v.severity === 'critical').length;
    const high = vulnerabilities.filter(v => v.severity === 'high').length;
    const medium = vulnerabilities.filter(v => v.severity === 'medium').length;
    const low = vulnerabilities.filter(v => v.severity === 'low').length;
    const exploitable = vulnerabilities.filter(v => v.exploitable).length;
    return {
        total: vulnerabilities.length,
        critical,
        high,
        medium,
        low,
        exploitable,
        items: vulnerabilities,
    };
}
async function analyzeExploitability(cve) {
    // In production, this would query exploit databases
    // For now, use CVSS metrics to estimate
    return cve.exploitable || (cve.cvssScore >= 7.0 && cve.severity === 'critical');
}
